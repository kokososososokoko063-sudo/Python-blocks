<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مفسّر Python باللبنات (Scratch-like)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px;
            text-align: center;
        }
        #workspace-container {
            flex-grow: 1;
            display: flex;
            flex-direction: row;
        }
        #blocklyDiv {
            flex-grow: 1;
            height: 100%;
            min-width: 400px; /* لضمان رؤية جيدة */
        }
        #output-panel {
            width: 300px;
            background-color: #f0f0f0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ccc;
        }
        #output-area {
            flex-grow: 1;
            background-color: white;
            border: 1px solid #ccc;
            padding: 5px;
            overflow: auto;
            white-space: pre-wrap;
            margin-bottom: 10px;
            text-align: left; /* لعرض مخرجات Python بشكل صحيح */
        }
        button {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
</head>
<body>

    <header>
        <h1>مفسّر Python باللبنات</h1>
        <p>قم بتجميع اللبنات ثم اضغط على "تشغيل الكود" لتنفيذ Python في المتصفح.</p>
    </header>

    <div id="workspace-container">
        <div id="output-panel">
            <h3>الإخراج (Output)</h3>
            <div id="output-area"></div>
            <button onclick="runCode()">تشغيل الكود</button>
        </div>

        <div id="blocklyDiv"></div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="المنطق" colour="210">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_boolean"></block>
        </category>
        <category name="الحلقات" colour="120">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
        </category>
        <category name="الرياضيات" colour="230">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
        </category>
        <category name="المتغيرات" custom="VARIABLE" colour="330"></category>
        <category name="الدوال" custom="PROCEDURE" colour="290"></category>
        <category name="مدخلات/مخرجات" colour="160">
            <block type="text_print">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">مرحباً بالعالم!</field>
                    </shadow>
                </value>
            </block>
            <block type="text"></block>
        </category>
    </xml>

    <script>
        // تهيئة Pyodide
        let pyodideReady = false;
        let pyodide;
        const outputArea = document.getElementById('output-area');

        async function initializePyodide() {
            outputArea.textContent = '... يتم تحميل مفسّر Python (Pyodide) ...';
            try {
                pyodide = await loadPyodide();
                pyodideReady = true;
                outputArea.textContent = 'جاهز! Pyodide (Python) يعمل بنجاح.';
            } catch (error) {
                outputArea.textContent = `فشل تحميل Pyodide: ${error}`;
                console.error('Error loading Pyodide:', error);
            }
        }
        // ابدأ بتحميل Pyodide فور تحميل الصفحة
        initializePyodide();

        // ----------------------------------------------------
        // 1. تهيئة مساحة عمل Blockly
        // ----------------------------------------------------
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            rtl: true, // تفعيل الاتجاه من اليمين لليسار (RTL)
            scrollbars: true,
            trashcan: true,
        });

        // ----------------------------------------------------
        // 2. دالة تشغيل الكود
        // ----------------------------------------------------
        function runCode() {
            if (!pyodideReady) {
                outputArea.textContent = 'انتظر حتى ينتهي تحميل مفسّر Python.';
                return;
            }

            // مسح المخرجات السابقة
            outputArea.textContent = '--- بدء التنفيذ --- \n';

            // 1. توليد كود Python من اللبنات
            const code = Blockly.Python.workspaceToCode(workspace);

            // عرض الكود الذي تم توليده في سجل المتصفح
            console.log('Generated Python Code:\n', code);

            // 2. إعداد دالة الطباعة لـ Python لتظهر في منطقة الإخراج (Output Area)
            // هذا يسمح لـ `print()` في Python بالكتابة في HTML بدلاً من سجل المتصفح
            pyodide.globals.set('print', (data) => {
                outputArea.textContent += data.toString() + '\n';
            });
            
            // 3. تنفيذ الكود داخل Pyodide
            try {
                pyodide.runPython(code);
                outputArea.textContent += '--- انتهى التنفيذ بنجاح ---';
            } catch (error) {
                // عرض أي خطأ في التنفيذ
                outputArea.textContent += `\n!!! خطأ في التنفيذ !!!\n${error}`;
                console.error('Execution Error:', error);
            }
        }

        // ----------------------------------------------------
        // 3. وظيفة إضافية: تغيير اسم مولد الكود إلى Python لـ Blockly
        // ----------------------------------------------------
        // تأكد من استخدام مولد كود Python
        Blockly.Python.init(workspace); 
        // قم بتعيين اسم مولد اللغة الحالي إلى 'Blockly.Python'
        Blockly.generator = Blockly.Python;

    </script>

</body>
</html>
